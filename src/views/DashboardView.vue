<script setup lang="ts">
import { onMounted, ref } from 'vue';

import GraficoPessoasDia from '@/components/GraficoPessoasDia.vue'
import Titulo from '@/components/Titulo.vue';
import Indicador from '@/components/Indicador.vue';
import LoadingBar from '@/components/LoadingBar.vue';

import Dashboard from '@/services/Dashboard';
import Redzone from '@/services/Redzone';
import Relatorio from '@/services/Relatorio';

import type IDashboardResponse from "@/interfaces/IDashboardResponse";
import type IRedzone from '@/interfaces/IRedzone';

const state = ref({
  graphic_data: {} as IDashboardResponse,
  redzones: [] as IRedzone[],
  selectedRedzone: 'Todos',
  loading: false,
  error: false,
  errorExport: false,
  successExport: false,
  loadingExportTable: false,
  loadingExportGraphic: false,
});

const headers = [
  {
    key: 'data',
    title: 'Data/Horário',
  },
  {
    key: 'tipo',
    title: 'Entrada/Saída',
  },
  {
    key: 'redzone',
    title: 'Redzone',
  },
]

const getDashboard = () => {
  state.value.loading = true;
  Dashboard.getDashboard(state.value.selectedRedzone !== 'Todos' ? Number(state.value.selectedRedzone.split('-')[0]) : undefined)
    .then(res => {
      if (res.data && res.status == 200) {
        state.value.graphic_data = res.data
      } else {
        state.value.error = true;
        console.log(res);
      }
      state.value.loading = false;
    })
    .catch(err => {
      console.log(err);
      state.value.error = true;
      state.value.loading = false;
    });
}

const exportContent = (source: 'table' | 'graphic') => {
  if (source == 'table') state.value.loadingExportTable = true;
  if (source == 'graphic') state.value.loadingExportGraphic = true;
  Relatorio.getRelatorio(source == 'table' ? 'all' : '7-days')
    .then(res => {
      if (res.status !== 200) {
        state.value.errorExport = true;
      } else {
        state.value.successExport = true;
      }
      if (source == 'table') state.value.loadingExportTable = false;
      if (source == 'graphic') state.value.loadingExportGraphic = false;
    })
    .catch(err => {
      console.log(err);
      state.value.errorExport = true;
      if (source == 'table') state.value.loadingExportTable = false;
      if (source == 'graphic') state.value.loadingExportGraphic = false;
    });
}

onMounted(() => {
  getDashboard();

  state.value.loading = true;
  Redzone.getRedzones()
    .then(res => {
      if (res.status == 200) {
        state.value.redzones = res.data;
      } else {
        state.value.error = true;
        console.log(res);
      }
      state.value.loading = false;
    })
    .catch(err => {
      console.log(err);
      state.value.error = true;
      state.value.loading = false;
    });
});

</script>

<template>
  <LoadingBar :visible="state.loading" />
  <v-snackbar color="red" v-model="state.error">
    Um erro interno aconteceu. Tente novamente mais tarde.
  </v-snackbar>
  <v-snackbar color="red" v-model="state.errorExport">
    Erro ao baixar arquivo. Tente novamente mais tarde
  </v-snackbar>
  <v-snackbar color="green" v-model="state.successExport">
    Exportado com sucesso! Baixando arquivo...
  </v-snackbar>
  <main class="dashboard-main">
    <Titulo style="margin: 12px auto;" content="Dashboard" />
    <div class="dashboard-content">
      <div class="dashboard-filters">
        <v-select label="Redzone" variant="underlined" :items="[
    'Todos',
    ...state.redzones.map(redzone => `${redzone.id} - ${redzone.nome}`)
  ]" v-model="state.selectedRedzone" @update:model-value="getDashboard"></v-select>
      </div>
      <div class="dashboard-content-row">
        <div class="dashboard-graphic">
          <v-tooltip bottom>
            <template v-slot:activator="{ props }">
              <v-btn class="dashboard-download-btn" icon="mdi-download" variant="text" color="#004488" v-bind="props"
                :loading="state.loadingExportGraphic" @click="exportContent('graphic')"></v-btn>
            </template>
            <span>Baixar relatório últimos 7 dias</span>
          </v-tooltip>
          <h1 class="dashboard-title">
            Quantidade de pessoas por dia (últimos 7 dias)
          </h1>
          <GraficoPessoasDia :loading="state.loading" :graphic_data="state.graphic_data?.grafico" />
        </div>
        <div class="dashboard-indicators">
          <h1 class="dashboard-title">
            Indicadores
          </h1>
          <Indicador class="dashboard-indicator" title="Pessoas em redzone" subtitle="Neste momento" :value="`${state.graphic_data?.indicadores?.total_pessoas !== undefined ?
    state.graphic_data?.indicadores?.total_pessoas
    : '-'}`" />
          <Indicador class="dashboard-indicator" title="Total de entradas" subtitle="Desde o início" :value="`${state.graphic_data?.indicadores?.total_entradas !== undefined ?
    state.graphic_data?.indicadores?.total_entradas
    : '-'}`" />
        </div>
      </div>
      <hr style="width: 95%; margin: auto; opacity: 30%;" />
      <div style="margin-top: 12px;" class="dashboard-content-row">
        <div class="dashboard-table">
          <v-tooltip bottom>
            <template v-slot:activator="{ props }">
              <v-btn class="dashboard-download-btn" icon="mdi-download" variant="text" color="#004488" v-bind="props"
                :loading="state.loadingExportTable" @click="exportContent('table')"></v-btn>
            </template>
            <span>Baixar tabela em XLSX</span>
          </v-tooltip>
          <h1 class="dashboard-title">
            Registros de entradas e saídas
          </h1>
          <v-data-table :headers="headers" :items="state.graphic_data?.tabela">
            <template v-slot:item.data="{ item }">
              {{ new Date(item.data).toLocaleDateString('pt-BR') }}
            </template>
            <template v-slot:item.tipo="{ item }">
              {{ item.tipo == 'entrada' ? 'Entrada' : 'Saída' }}
            </template>
          </v-data-table>
        </div>
      </div>
    </div>
  </main>
</template>

<style scoped>
.dashboard-main {
  margin-top: -12px;
}

.dashboard-content {
  margin: 12px auto;
  width: calc(100% - 48px);
  display: flex;
  flex-direction: column;
}

.dashboard-content-row {
  display: flex;
  flex-direction: row;
  gap: 24px;
}

.dashboard-filters {
  width: 320px;
}

.dashboard-graphic,
.dashboard-table {
  flex: 1;
  position: relative;
}

.dashboard-indicators {
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  width: fit-content;
  align-items: center;
  align-self: flex-start;
  gap: 16px;
  height: 200px;
}

.dashboard-indicator {
  flex: 1;
}

.dashboard-title {
  font-size: 18px;
  text-align: center;
  margin-bottom: 12px;
}

.dashboard-download-btn {
  position: absolute;
  top: 0;
  right: 0;
}
</style>